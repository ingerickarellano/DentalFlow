NUEVO USUARIO/MEMBRESIA

DO $$
DECLARE
    v_user_id UUID;
    v_email TEXT := 'emea.elsalvarez@gmail.com';
    v_plan TEXT := 'profesional';
    v_dias INTEGER := 30;  -- ✅ Duración del contrato: 30 días
    v_fecha_expiracion DATE;
BEGIN
    -- 1. Obtener el ID del usuario desde auth.users
    SELECT id INTO v_user_id FROM auth.users WHERE email = v_email;
    IF v_user_id IS NULL THEN
        RAISE EXCEPTION '❌ Usuario con email % no encontrado en auth.users', v_email;
    END IF;

    -- 2. Calcular fecha de expiración (hoy + 30 días)
    v_fecha_expiracion := CURRENT_DATE + v_dias;

    -- 3. Insertar o actualizar perfil en perfiles_usuarios
    INSERT INTO perfiles_usuarios (
        id,
        email,
        nombre,
        laboratorio,
        rol,
        plan,
        suscripcion_activa,
        fecha_expiracion,
        actualizado_en
    )
    VALUES (
        v_user_id,
        v_email,
        COALESCE(
            (SELECT raw_user_meta_data->>'nombre' FROM auth.users WHERE id = v_user_id),
            split_part(v_email, '@', 1)
        ),
        COALESCE(
            (SELECT raw_user_meta_data->>'laboratorio' FROM auth.users WHERE id = v_user_id),
            'Laboratorio Dental'
        ),
        'cliente',
        v_plan,
        true,                      -- suscripcion_activa = true
        v_fecha_expiracion,
        NOW()
    )
    ON CONFLICT (id) DO UPDATE SET
        plan = EXCLUDED.plan,
        suscripcion_activa = EXCLUDED.suscripcion_activa,
        fecha_expiracion = EXCLUDED.fecha_expiracion,
        actualizado_en = EXCLUDED.actualizado_en,
        laboratorio = EXCLUDED.laboratorio,
        nombre = EXCLUDED.nombre,
        email = EXCLUDED.email;

    RAISE NOTICE '✅ Usuario % activado con plan % hasta %', v_email, v_plan, v_fecha_expiracion;
END $$;

CORROBORAR ESTADO
SELECT 
    email,
    plan,
    suscripcion_activa,
    fecha_expiracion,
    actualizado_en
FROM perfiles_usuarios
WHERE email = 'emea.elsalvarez@gmail.com';